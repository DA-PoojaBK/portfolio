/*
Covid 19 Data Exploration 
Skills used: Joins, CTE's, Temp Tables, Windows Functions, Aggregate Functions, Creating Views, Converting Data Types
*/

--Looking at Total cases vs Total deaths
--Shows the likelihood of you dying if you contract covid in your country

SELECT location, date, total_cases, total_deaths, (total_deaths/total_cases)*100 AS DeathPercentage
FROM COVID..CovidDeaths
WHERE location ='India' AND continent IS NOT NULL
ORDER BY 1,2

--Looking at Total cases vs Population
--Show what percentage of population got infected with Covid

SELECT location, date, total_cases, population, (total_cases/population)*100 AS CasePercentage
FROM COVID..CovidDeaths
WHERE continent IS NOT NULL
ORDER BY 1,2

--Looking at Countries with Highest infection rate compared to population

SELECT location, population, MAX(total_cases) AS HighestInfectionCount, MAX((total_cases/population))*100 AS PercentPopulationInfected
FROM COVID..CovidDeaths
WHERE continent IS NOT NULL
GROUP BY location, population
ORDER BY PercentPopulationInfected DESC

--Showing Countries with Highest Death count per Population

SELECT location, MAX(total_deaths) AS TotalDeathCount
FROM COVID..CovidDeaths
WHERE continent IS NOT NULL
GROUP BY location
ORDER BY TotalDeathCount DESC

--Showing Death count by Continent

SELECT continent, MAX(total_deaths) AS TotalDeathCount
FROM COVID..CovidDeaths
WHERE continent IS NOT NULL
GROUP BY continent
ORDER BY TotalDeathCount DESC


--Global cases vs deaths

SELECT SUM(new_cases) AS TotalCases, SUM(new_deaths) AS TotalDeaths, SUM(new_deaths)/SUM(new_cases)*100 AS DeathPercentage
FROM COVID..CovidDeaths
WHERE continent IS NOT NULL
ORDER BY 1,2

--Showing Global cases vs deaths by date

SELECT date, SUM(new_cases) AS TotalCases, SUM(new_deaths) AS TotalDeaths, SUM(new_deaths)/SUM(new_cases)*100 AS DeathPercentage
FROM CovidDeaths
WHERE continent IS NOT NULL
GROUP BY date

--Total Population vs Vaccinations
â€”Shows Percentage of Population that has received at least one Covid vaccine

SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations, 
SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS PeopleVaccinated
FROM COVID..CovidDeaths dea 
JOIN COVID..CovidVaccinations vac 
    ON dea.location = vac.location 
    AND dea.date = vac.date
WHERE dea.continent IS NOT NULL
ORDER BY 2,3

--Using CTE to get the global vaccinated percentage

WITH VaccVSPopu (continent, location, date, population, new_vaccinations, PeopleVaccinated)
AS
(
SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS PeopleVaccinated
FROM COVID..CovidDeaths dea 
JOIN COVID..CovidVaccinations vac 
    ON dea.location = vac.location 
    and dea.date = vac.date
WHERE dea.continent IS NOT NULL
)
SELECT *, PeopleVaccinated/population*100 AS VaccinatedPercent
FROM VaccVSPopu

--TEMP Table

DROP TABLE IF EXISTS #PeopleVaccinatedPercent
CREATE TABLE #PeopleVaccinatedPercent
( 
Continent VARCHAR(50),
Location VARCHAR(50),
Date  DATE,
Population NUMERIC,
NewVaccinations NUMERIC,
TotalVaccinated NUMERIC
)
INSERT INTO #PeopleVaccinatedPercent
SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS PeopleVaccinated
FROM COVID..CovidDeaths dea 
JOIN COVID..CovidVaccinations vac 
    ON dea.location = vac.location 
    and dea.date = vac.date
WHERE dea.continent IS NOT NULL

SELECT *, PeopleVaccinated/population*100 AS VaccinatedPercent
FROM #PeopleVaccinatedPercent


--Creating views to store data for later visualizations

CREATE VIEW PeopleVaccinatedPercent AS
SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS PeopleVaccinated
FROM COVID..CovidDeaths dea 
JOIN COVID..CovidVaccinations vac 
    ON dea.location = vac.location 
    and dea.date = vac.date
WHERE dea.continent IS NOT NULL

SELECT *
FROM PeopleVaccinatedPercent
